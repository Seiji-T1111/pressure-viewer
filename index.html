<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>体調記録アプリ</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      flex-direction: column;
      min-height: 100vh;
      background: #f9f9f9;
    }
    h1 { margin: 1em 0; text-align: center; }
    #content { max-width: 900px; width: 95%; margin: auto; }
    #chartContainer { width: 100%; }
    table { border-collapse: collapse; width: 100%; margin-top: 1em; background: #fff; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    th { background: #eee; }
    input.memo { width: 90%; }
    label { display: block; margin-bottom: 1em; }
  </style>
</head>
<body>
  <div id="content">
    <h1>体調記録アプリ</h1>

    <label>表示期間:
      <select id="periodSelect">
        <option value="7">1週間</option>
        <option value="14" selected>2週間</option>
        <option value="30">1ヶ月</option>
      </select>
    </label>

    <div id="chartContainer">
      <canvas id="pressureChart"></canvas>
    </div>

    <table id="dataTable"></table>
  </div>

  <script>
  const LAT = 35.68, LON = 139.76; // 東京
  const SCORE_LABELS = ["とても悪い","悪い","普通","良い","とても良い"];
  const STORAGE_KEY = "userSymptomData"; // 過去の記録も読み込む

  let chart;
  let ctx = document.getElementById("pressureChart").getContext("2d");
  let dailyData = [];
  let symptomData = {};

  // 過去データを読み込む
  try {
    symptomData = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
  } catch(e) { symptomData = {}; }

  async function fetchWeatherData(days){
    const start = new Date();
    start.setDate(start.getDate() - days + 1);
    const startStr = start.toISOString().split("T")[0];
    const endStr = new Date().toISOString().split("T")[0];

    const url = `https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}&hourly=pressure_msl,weathercode&timezone=Asia/Tokyo&start_date=${startStr}&end_date=${endStr}`;
    const res = await fetch(url);
    return await res.json();
  }

  function processData(raw){
    const hourly = raw.hourly;
    const map = {};
    for(let i=0;i<hourly.time.length;i++){
      const d = hourly.time[i].split("T")[0];
      if(!map[d]) map[d] = {sum:0,count:0,weather:hourly.weathercode[i]};
      map[d].sum += hourly.pressure_msl[i];
      map[d].count++;
    }
    return Object.keys(map).map(d=>({
      date:d,
      pressure:map[d].sum/map[d].count,
      weather:map[d].weather
    }));
  }

  function labelToScore(label){
    if(!label) return NaN;
    const idx = SCORE_LABELS.indexOf(label);
    return idx>=0 ? idx+1 : NaN;
  }

  function saveData() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(symptomData));
  }

  function renderTable(){
    const tbl = document.getElementById("dataTable");
    tbl.innerHTML = "<tr><th>日付</th><th>平均気圧</th><th>天気</th><th>体調</th><th>メモ</th></tr>";

    // 新しい日付から順に表示
    const sorted = [...dailyData].sort((a,b)=> new Date(b.date) - new Date(a.date));

    sorted.forEach(row=>{
      const tr = tbl.insertRow(-1);
      tr.insertCell().textContent = row.date;
      tr.insertCell().textContent = row.pressure.toFixed(1);
      tr.insertCell().textContent = row.weather;

      // 体調プルダウン
      const sel = document.createElement("select");
      ["","とても悪い","悪い","普通","良い","とても良い"].forEach(l=>{
        const o = document.createElement("option");
        o.value = l; o.textContent = l;
        if(symptomData[row.date]?.condition===l) o.selected = true;
        sel.appendChild(o);
      });
      sel.addEventListener("change",()=>{
        if(!symptomData[row.date]) symptomData[row.date] = {};
        symptomData[row.date].condition = sel.value;
        saveData();
        updateChartData();
      });
      tr.insertCell().appendChild(sel);

      // メモ欄
      const input = document.createElement("input");
      input.type = "text";
      input.maxLength = 100;
      input.value = symptomData[row.date]?.memo || "";
      input.className = "memo";
      input.addEventListener("input", ()=>{
        if(!symptomData[row.date]) symptomData[row.date] = {};
        symptomData[row.date].memo = input.value;
        saveData();
      });
      tr.insertCell().appendChild(input);
    });
  }

  function updateChartData(){
    const labels = dailyData.map(d=>d.date);
    const values = dailyData.map(d=>{
      const sc = labelToScore(symptomData[d.date]?.condition);
      return Number.isNaN(sc)?null:sc;
    });
    chart.data.labels = labels;
    chart.data.datasets[1].data = values;
    chart.update();
  }

  const weatherBgPlugin = {
    id:"weatherBg",
    beforeDraw(chart){
      const {ctx,chartArea:{left,right,top,bottom},scales:{x}} = chart;
      ctx.save();
      dailyData.forEach((d,i)=>{
        const xStart = x.getPixelForTick(i)-x.getPixelForTick(0)/2;
        const xEnd = x.getPixelForTick(i+1)-x.getPixelForTick(0)/2;
        ctx.fillStyle = (d.weather<3)?"#d0e7ff22":
                        (d.weather<51)?"#eeeebb55":"#cccccc55";
        ctx.fillRect(xStart,top,xEnd-xStart,bottom-top);
      });
      ctx.restore();
    }
  };

  async function render(days){
    const raw = await fetchWeatherData(days);
    dailyData = processData(raw);

    if(chart) chart.destroy();
    chart = new Chart(ctx, {
      type:"line",
      data:{
        labels: dailyData.map(d=>d.date),
        datasets:[
          {label:"平均気圧(hPa)",data:dailyData.map(d=>d.pressure),
           borderColor:"red",yAxisID:"y1"},
          {label:"体調(1〜5)",data:[],
           borderColor:"blue",yAxisID:"y2"}
        ]
      },
      options:{
        responsive:true,
        scales:{
          y1:{type:"linear",position:"left",title:{display:true,text:"気圧(hPa)"}},
          y2:{type:"linear",position:"right",min:1,max:5,
              ticks:{callback:v=>SCORE_LABELS[v-1]||""},
              title:{display:true,text:"体調"}}
        }
      },
      plugins:[weatherBgPlugin]
    });

    renderTable();
    updateChartData();
  }

  document.getElementById("periodSelect").addEventListener("change",e=>{
    render(+e.target.value);
  });

  render(14); // 初期表示
  </script>
</body>
</html>
