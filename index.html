<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>月別気圧と体調スコア入力（東京）</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: sans-serif; margin: 20px; background: #f8f9fa; }
  h1 { font-size: 1.4em; margin-bottom: 12px; }
  #monthSelect { font-size: 1em; padding: 6px; margin-bottom: 16px; }

  .tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
    flex-wrap: nowrap;
  }
  .tab {
    flex-grow: 1;
    min-width: 100px;
    padding: 10px 0;
    background: #e0e0e0;
    color: #444;
    text-align: center;
    cursor: pointer;
    user-select: none;
    border-radius: 6px 6px 0 0;
    font-weight: 600;
  }
  .tab.active {
    background: white;
    border-bottom: 3px solid #36a2eb;
    color: #0366d6;
  }

  #chartContainer, #tableContainer {
    background: white;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
    padding: 20px;
    max-width: 1000px;
    margin-bottom: 24px;
  }
  #tableContainer {
    max-height: 500px;
    overflow-x: auto;
    overflow-y: auto;
  }
  table {
    width: 100%; border-collapse: collapse; 
    min-width: 700px;
  }
  th, td {
    border: 1px solid #ddd; padding: 8px; text-align: center;
    vertical-align: middle;
  }
  th { background: #f3f3f3; }
  tr.today { background: #fff7cc; font-weight: 700; }
  .up { color: #1b6e20; }
  .down { color: #c02828; }
  .nochange { color: #666; }
  select.bodySelect {
    font-size: 1em;
    padding: 2px 6px;
  }
  input.memoInput {
    width: 100%;
    min-width: 120px;
    max-width: 200px;
    box-sizing: border-box;
    font-size: 0.9em;
    padding: 2px 6px;
  }
</style>
</head>
<body>
<h1>月別気圧と体調スコア入力（東京）</h1>

<label for="monthSelect">表示する月を選択：</label>
<select id="monthSelect"></select>

<div class="tabs">
  <div id="tabChart" class="tab active">グラフ</div>
  <div id="tabTable" class="tab">表</div>
</div>

<div id="chartContainer">
  <canvas id="pressureChart"></canvas>
</div>

<div id="tableContainer" style="display:none;">
  <table>
    <thead>
      <tr>
        <th>日付</th><th>平均気圧 (hPa)</th><th>前日比</th><th>体調スコア</th><th>メモ</th><th>天気</th>
      </tr>
    </thead>
    <tbody id="dataBody"></tbody>
  </table>
</div>

<script>
(async function(){
  const lat = 35.6895;
  const lon = 139.6917;

  // 月リスト作成: 2025/1～今月まで
  const monthList = [];
  const today = new Date();
  const startYear = 2025;
  const startMonth = 1;

  for(let y = startYear; y <= today.getFullYear(); y++){
    const maxMonth = (y === today.getFullYear()) ? today.getMonth()+1 : 12;
    for(let m = 1; m <= maxMonth; m++){
      monthList.push({year: y, month: m});
    }
  }

  // セレクトに月追加
  const monthSelect = document.getElementById('monthSelect');
  monthList.forEach(({year,month}) => {
    const opt = document.createElement('option');
    opt.value = `${year}-${String(month).padStart(2,'0')}`;
    opt.textContent = `${year}年${month}月`;
    monthSelect.appendChild(opt);
  });
  monthSelect.value = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}`;

  // API 1年分データ取得（日気圧＋天気コード）
  const startDateStr = `${startYear}-01-01`;
  const endDateStr = today.toISOString().split('T')[0];
  const apiUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&start_date=${startDateStr}&end_date=${endDateStr}&hourly=pressure_msl&daily=weathercode&timezone=Asia/Tokyo`;

  const res = await fetch(apiUrl);
  const json = await res.json();

  // --- 日毎平均気圧算出 ---
  const times = json.hourly.time;
  const pressures = json.hourly.pressure_msl;
  const dailyWeatherDates = json.daily.time;
  const dailyWeatherCodes = json.daily.weathercode;

  const dailyDataMap = {};
  for(let i=0; i<times.length; i++){
    const d = times[i].split('T')[0];
    if(!dailyDataMap[d]) dailyDataMap[d] = [];
    dailyDataMap[d].push(pressures[i]);
  }

  const dailyDataAll = Object.entries(dailyDataMap).map(([date, vals]) => {
    const avg = vals.reduce((a,b)=>a+b,0)/vals.length;
    // 天気コード取得
    const widx = dailyWeatherDates.indexOf(date);
    const weathercode = widx >= 0 ? dailyWeatherCodes[widx] : null;
    return {date, avg: +avg.toFixed(1), weathercode};
  }).sort((a,b) => a.date.localeCompare(b.date));

  // 体調スコア設定
  const scoreText = {1:'悪い',2:'やや悪い',3:'ふつう',4:'やや良い',5:'良い'};
  const storageKey = 'userSymptomDataWithMemo';
  let symptomData = {};
  try {
    const stored = localStorage.getItem(storageKey);
    if(stored) symptomData = JSON.parse(stored);
  } catch(e){console.warn('localStorage読み込み失敗', e);}

  function saveSymptomData(){
    localStorage.setItem(storageKey, JSON.stringify(symptomData));
  }

  function getWeekday(dateStr){
    const days = ['日','月','火','水','木','金','土'];
    return days[new Date(dateStr).getDay()];
  }

  // 月別データ抽出
  function getDataByMonth(yearMonth){
    return dailyDataAll.filter(d => d.date.startsWith(yearMonth));
  }

  // 前日比計算
  function calcChanges(data){
    return data.map((d,i)=>{
      if(i === 0) return { ...d, change: null };
      return { ...d, change: +(d.avg - data[i-1].avg).toFixed(1) };
    });
  }

  // 天気コードから背景色決定
  function weatherCodeToColor(code){
    if(code === null) return 'transparent';
    if([0].includes(code)) return '#fff9c4';  // 晴れ：薄い黄色
    if([1,2,3].includes(code)) return '#cfd8dc';  // 曇り：薄グレー
    if([45,48].includes(code)) return '#b0bec5';  // 霧・霧雨
    if([51,53,55,56,57,61,63,65,66,67,80,81,82].includes(code)) return '#90caf9'; // 雨系：薄青
    if([71,73,75,77,85,86].includes(code)) return '#81d4fa'; // 雪系：薄水色
    return 'transparent';
  }

  // 表描画
  const tbody = document.getElementById('dataBody');
  function renderTable(data){
    tbody.innerHTML = '';
    const todayStr = new Date().toISOString().split('T')[0];
    data.forEach((d,i) => {
      const tr = document.createElement('tr');
      if(d.date === todayStr) tr.classList.add('today');

      const changeTd = document.createElement('td');
      if(i === 0){
        changeTd.textContent = '—';
        changeTd.classList.add('nochange');
      } else if(d.change > 0){
        changeTd.textContent = `▲ ${d.change} hPa`;
        changeTd.classList.add('up');
      } else if(d.change < 0){
        changeTd.textContent = `▼ ${Math.abs(d.change)} hPa`;
        changeTd.classList.add('down');
      } else {
        changeTd.textContent = '±0.0';
        changeTd.classList.add('nochange');
      }

      const dateWithWeek = `${d.date}（${getWeekday(d.date)}）`;

      tr.innerHTML = `<td>${dateWithWeek}</td><td>${d.avg}</td>`;
      tr.appendChild(changeTd);

      // 体調スコア
      const symptomTd = document.createElement('td');
      const select = document.createElement('select');
      select.classList.add('bodySelect');
      [1,2,3,4,5].forEach(v=>{
        const opt = document.createElement('option');
        opt.value = v;
        opt.textContent = `${v} (${scoreText[v]})`;
        select.appendChild(opt);
      });
      select.value = symptomData[d.date]?.score ?? 3;
      select.addEventListener('change', e => {
        if(!symptomData[d.date]) symptomData[d.date] = {};
        symptomData[d.date].score = Number(e.target.value);
        saveSymptomData();
        updateChart();
      });
      symptomTd.appendChild(select);
      tr.appendChild(symptomTd);

      // メモ欄
      const memoTd = document.createElement('td');
      const input = document.createElement('input');
      input.type = 'text';
      input.classList.add('memoInput');
      input.maxLength = 100;
      input.placeholder = 'メモ（100字以内）';
      input.value = symptomData[d.date]?.memo ?? '';
      input.addEventListener('input', e => {
        if(!symptomData[d.date]) symptomData[d.date] = {};
        symptomData[d.date].memo = e.target.value;
        saveSymptomData();
      });
      memoTd.appendChild(input);
      tr.appendChild(memoTd);

      // 天気表示（テキスト＋背景色）
      const weatherTd = document.createElement('td');
      weatherTd.textContent = d.weathercode !== null ? d.weathercode : '-';
      weatherTd.style.backgroundColor = weatherCodeToColor(d.weathercode);
      tr.appendChild(weatherTd);

      tbody.appendChild(tr);
    });
  }
  // --- グラフ作成 ---
  const ctx = document.getElementById('pressureChart').getContext('2d');
  let chartInstance = null;

  function updateChart(){
    const ym = monthSelect.value;
    const filtered = getDataByMonth(ym);
    const dataWithChange = calcChanges(filtered);

    const labels = dataWithChange.map(d => d.date.split('-')[2] + '日');
    const dataPoints = dataWithChange.map(d => d.avg);
    const bgColors = dataWithChange.map(d => weatherCodeToColor(d.weathercode));

    // 体調スコアによるポイント色
    const symptomColors = dataWithChange.map(d => {
      const score = symptomData[d.date]?.score ?? 3;
      switch(score){
        case 1: return '#d32f2f'; // 悪い 赤
        case 2: return '#f57c00'; // やや悪い オレンジ
        case 3: return '#666';    // ふつう グレー
        case 4: return '#388e3c'; // やや良い 緑
        case 5: return '#1976d2'; // 良い 青
        default: return '#666';
      }
    });

    // グラフの背景に天気色を帯で表示するプラグイン
    const weatherBgPlugin = {
      id: 'weatherBgPlugin',
      beforeDraw(chart) {
        const { ctx, chartArea: { left, right, top, bottom }, scales: { x } } = chart;
        const count = labels.length;
        const bandWidth = (right - left) / count;
        ctx.save();
        for(let i = 0; i < count; i++){
          ctx.fillStyle = bgColors[i] || 'transparent';
          ctx.fillRect(left + bandWidth*i, top, bandWidth, bottom - top);
        }
        ctx.restore();
      }
    };

    if(chartInstance){
      chartInstance.destroy();
    }
    chartInstance = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: '平均気圧 (hPa)',
          data: dataPoints,
          borderColor: '#36a2eb',
          backgroundColor: 'rgba(54, 162, 235, 0.2)',
          fill: true,
          tension: 0.3,
          pointRadius: 5,
          pointBackgroundColor: symptomColors
        }]
      },
      options: {
        scales: {
          y: {
            suggestedMin: Math.min(...dataPoints) - 5,
            suggestedMax: Math.max(...dataPoints) + 5,
            title: { display: true, text: '気圧 (hPa)' }
          }
        },
        plugins: {
          legend: { display: true }
        }
      },
      plugins: [weatherBgPlugin]
    });

    renderTable(dataWithChange);
  }

  // タブ切り替え
  const tabChart = document.getElementById('tabChart');
  const tabTable = document.getElementById('tabTable');
  const chartContainer = document.getElementById('chartContainer');
  const tableContainer = document.getElementById('tableContainer');

  tabChart.addEventListener('click', () => {
    tabChart.classList.add('active');
    tabTable.classList.remove('active');
    chartContainer.style.display = 'block';
    tableContainer.style.display = 'none';
  });
  tabTable.addEventListener('click', () => {
    tabTable.classList.add('active');
    tabChart.classList.remove('active');
    chartContainer.style.display = 'none';
    tableContainer.style.display = 'block';
  });

  // 月セレクト変更イベント
  monthSelect.addEventListener('change', updateChart);

  // 最初に表示
  updateChart();

})();
</script>
</body>
</html>
