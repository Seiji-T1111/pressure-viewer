<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>æ°—åœ§ãƒ»ä½“èª¿å…¥åŠ›ã¨ã‚°ãƒ©ãƒ•ï¼ˆæ±äº¬ãƒ»éå»2é€±é–“ï¼‰</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: sans-serif; margin: 20px; background: #f8f9fa; }
  h1 { font-size: 1.4em; margin-bottom: 12px; }
  #toggleBtn { margin-bottom: 16px; padding: 8px 12px; cursor: pointer; }
  #chartContainer, #tableContainer {
    background: white;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
    padding: 20px;
    max-width: 1000px;
    margin-bottom: 24px;
  }
  #tableContainer { display: none;
  max-height: 500px; overflow-y: auto; }
  table { width: 100%; border-collapse: collapse; }
  th, td { border: 1px solid #ddd; padding: 8px; text-align: center; vertical-align: middle; }
  th { background: #f3f3f3; }
  tr.today { background: #fff7cc; font-weight: 700; }
  .up { color: #1b6e20; }
  .down { color: #c02828; }
  .nochange { color: #666; }
  select.score {
    padding: 4px 6px; border-radius: 6px; border: 1px solid #ccc; background: #fff;
  }
  #periodSelect { margin-bottom: 16px; padding: 4px 6px; }
</style>
</head>
<body>
<h1>æ±äº¬ã®æ°—åœ§ãƒ»ä½“èª¿å…¥åŠ›ï¼ˆå¤©å€™èƒŒæ™¯ä»˜ãï¼‰</h1>
<label>è¡¨ç¤ºæœŸé–“ï¼š
  <select id="periodSelect">
    <option value="7">1é€±é–“</option>
    <option value="14" selected>2é€±é–“</option>
    <option value="21">3é€±é–“</option>
    <option value="30">1ãƒ¶æœˆ</option>
    <option value="60">2ãƒ¶æœˆ</option>
    <option value="90">3ãƒ¶æœˆ</option>
  </select>
</label>
<button id="toggleBtn">è¡¨ã«åˆ‡ã‚Šæ›¿ãˆ</button>

<div id="chartContainer">
  <canvas id="pressureChart"></canvas>
</div>

<div id="tableContainer">
  <table>
    <thead>
      <tr>
        <th>æ—¥ä»˜</th><th>å¹³å‡æ°—åœ§ (hPa)</th><th>å‰æ—¥æ¯”</th><th>å¤©å€™</th><th>ä½“èª¿ï¼ˆãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ï¼‰</th>
      </tr>
    </thead>
    <tbody id="dataBody"></tbody>
  </table>
</div>

<script>
(async function() {
  const SCORE_LABELS = ["æ‚ªã„","å°‘ã—æ‚ªã„","ãµã¤ã†","å°‘ã—è‰¯ã„","è‰¯ã„"];
  const labelToScore = (label) => {
    const idx = SCORE_LABELS.indexOf(label);
    return idx >= 0 ? idx + 1 : NaN; 
  };
  const scoreToLabel = (score) => {
    const n = Number(score);
    return n >= 1 && n <= 5 ? SCORE_LABELS[n - 1] : "ãµã¤ã†";
  };

  const lat = 35.6895, lon = 139.6917;
  const fetchWeatherData = async (days) => {
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=pressure_msl,weathercode&timezone=Asia/Tokyo&past_days=${days}`;
    const res = await fetch(url);
    return await res.json();
  };

  const storageKey = 'userSymptomData';
  let symptomData = {};
  try {
    const stored = localStorage.getItem(storageKey);
    if (stored) symptomData = JSON.parse(stored);
  } catch(e) { console.warn(e); }

  const saveSymptomData = () => localStorage.setItem(storageKey, JSON.stringify(symptomData));

  function weatherToTextIcon(code){
    const map = {
      0:['æ™´ã‚Œ','â˜€ï¸','#FFEE93'],1:['ä¸»ã«æ™´ã‚Œ','ğŸŒ¤ï¸','#FFE6A7'],2:['ä¸€éƒ¨æ›‡ã‚Š','â›…','#D0D0D0'],
      3:['æ›‡ã‚Š','â˜ï¸','#A0A0A0'],45:['éœ§','ğŸŒ«ï¸','#C8C8C8'],48:['éœ§ï¼ˆæ°·æ™¶ï¼‰','ğŸŒ«ï¸','#C8C8C8'],
      51:['éœ§é›¨ï¼ˆå¼±ï¼‰','ğŸŒ¦ï¸','#9BC4E2'],53:['éœ§é›¨ï¼ˆä¸­ï¼‰','ğŸŒ§ï¸','#739ED1'],55:['éœ§é›¨ï¼ˆå¼·ï¼‰','ğŸŒ§ï¸','#4D78C1'],
      61:['å°é›¨ï¼ˆå¼±ï¼‰','ğŸŒ§ï¸','#79A7D3'],63:['å°é›¨ï¼ˆä¸­ï¼‰','ğŸŒ§ï¸','#5787B4'],65:['å°é›¨ï¼ˆå¼·ï¼‰','ğŸŒ§ï¸','#3C5D8E'],
      71:['å°é›ªï¼ˆå¼±ï¼‰','ğŸŒ¨ï¸','#B4C6D9'],73:['å°é›ªï¼ˆä¸­ï¼‰','ğŸŒ¨ï¸','#94AED5'],75:['å°é›ªï¼ˆå¼·ï¼‰','ğŸŒ¨ï¸','#7597D1'],
      95:['é›·é›¨','â›ˆï¸','#365F94'],99:['é›·é›¨ï¼ˆå¤§ç²’ã®é›¹ï¼‰','â›ˆï¸â„ï¸','#24425B']
    };
    return map[code]||['ä¸æ˜','â“','#FFFFFF'];
  }

  let chart, dailyData, dates;

  const ctx=document.getElementById('pressureChart').getContext('2d');
  const weatherBgPlugin={
    id:'weatherBg',
    beforeDraw(chart){
      const { ctx, chartArea:{left,right,top,bottom}, scales:{x} }=chart;
      for(let i=0;i<dailyData.length;i++){
        const wCode=dailyData[i].weatherCode;
        const [, , bgColor] = weatherToTextIcon(wCode);
        const xStart = i===0 ? left : x.getPixelForValue(dailyData[i].date);
        const xEnd = (i<dailyData.length-1)?x.getPixelForValue(dailyData[i+1].date):right;
        ctx.save();
        ctx.fillStyle=bgColor;
        ctx.globalAlpha=0.3;
        ctx.fillRect(xStart,top,xEnd-xStart,bottom-top);
        ctx.restore();
      }
    }
  };

  function mode(arr){
    const freq={};
    arr.forEach(v=>{ freq[v]=(freq[v]||0)+1; });
    return Number(Object.entries(freq).sort((a,b)=>b[1]-a[1])[0][0]);
  }

  function processData(raw){
    const times = raw?.hourly?.time ?? [];
    const pressures = raw?.hourly?.pressure_msl ?? [];
    const weatherCodes = raw?.hourly?.weathercode ?? [];
    const today = new Date().toISOString().split('T')[0];
    const todayDate = new Date(today);
    const daily = {};
    for(let i=0;i<times.length;i++){
      const dateStr = times[i].split('T')[0];
      const dateObj = new Date(dateStr);
      if(dateObj>todayDate) continue;
      if(!daily[dateStr]) daily[dateStr]={pressure:[],weather:[]};
      daily[dateStr].pressure.push(pressures[i]);
      daily[dateStr].weather.push(weatherCodes[i]);
    }
    const dateKeys=Object.keys(daily).sort();
    return dateKeys.map(d=>{
      const pAvg = daily[d].pressure.reduce((a,b)=>a+b,0)/daily[d].pressure.length;
      const wMode = mode(daily[d].weather);
      return {date:d,pressure:+pAvg.toFixed(1),weatherCode:wMode};
    });
  }

  function renderTable(){
    const tbody = document.getElementById('dataBody');
    tbody.innerHTML = '';
    dailyData.forEach((item,i)=>{
      const tr=document.createElement('tr');
      if(i===dailyData.length-1) tr.classList.add('today');
      const change = i===0 ? null : +(dailyData[i].pressure-dailyData[i-1].pressure).toFixed(1);
      const changeTd=document.createElement('td');
      if(i===0){ changeTd.textContent='â€”'; changeTd.classList.add('nochange'); }
      else if(change>0){ changeTd.innerHTML=`â–² ${change} hPa`; changeTd.classList.add('up'); }
      else if(change<0){ changeTd.innerHTML=`â–¼ ${Math.abs(change)} hPa`; changeTd.classList.add('down'); }
      else { changeTd.textContent='Â±0.0'; changeTd.classList.add('nochange'); }
      const [weatherText, weatherIcon] = weatherToTextIcon(item.weatherCode);
      const symptomTd=document.createElement('td');
      const sel=document.createElement('select'); sel.className='score';
      const placeholderOpt=document.createElement('option');
      placeholderOpt.textContent='ä½“èª¿ã‚’å…¥åŠ›'; placeholderOpt.value=''; sel.appendChild(placeholderOpt);
      SCORE_LABELS.forEach(lbl=>{
        const opt=document.createElement('option'); opt.value=lbl; opt.textContent=lbl; sel.appendChild(opt);
      });
      sel.value=symptomData[item.date]??'';
      sel.addEventListener('change',e=>{
        const val=e.target.value;
        if(val) symptomData[item.date]=val; else delete symptomData[item.date];
        saveSymptomData(); updateChartData();
      });
      symptomTd.appendChild(sel);
      tr.innerHTML=`<td>${item.date}</td><td>${item.pressure}</td>`; tr.appendChild(changeTd);
      tr.innerHTML+=`<td title="${weatherText}">${weatherIcon}</td>`; tr.appendChild(symptomTd);
      tbody.appendChild(tr);
    });
  }

  function updateChartData(){
    chart.data.labels = dates;
    chart.data.datasets[0].data = dailyData.map(d=>d.pressure);
    chart.data.datasets[1].data = dailyData.map(d=>{
      const sc = labelToScore(symptomData[d.date]);
      return Number.isNaN(sc)?NaN:sc;
    });
    chart.update();
  }

  async function render(days){
    const raw = await fetchWeatherData(days);
    dailyData = processData(raw);
    dates = daily
    border-collapse: collapse; 
    width: 100%; 
  }
  table th, table td { 
    border: 1px solid #ddd; 
    padding: 8px; 
    text-align: center; 
  }
  select, button { padding: 4px 8px; margin: 4px; }
</style>
</head>
<body>
<h1>æ°—åœ§ã¨ä½“èª¿ã®è¨˜éŒ²ï¼ˆæ±äº¬ï¼‰</h1>

<div>
  <label for="periodSelect">è¡¨ç¤ºæœŸé–“:</label>
  <select id="periodSelect">
    <option value="7">1é€±é–“</option>
    <option value="14">2é€±é–“</option>
    <option value="21">3é€±é–“</option>
    <option value="30">1ãƒ¶æœˆ</option>
    <option value="90">3ãƒ¶æœˆ</option>
  </select>
</div>

<button id="toggleBtn">å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º</button>

<div id="chartContainer">
  <canvas id="myChart" height="120"></canvas>
</div>

<div id="tableContainer">
  <h2>ä½“èª¿å…¥åŠ›</h2>
  <table id="dataTable"></table>
</div>

<script>
const API_URL = "https://api.open-meteo.com/v1/forecast?latitude=35.68&longitude=139.76&hourly=pressure_msl,weathercode&timezone=Asia%2FTokyo&past_days=90";
const CONDITION_LEVELS = ["æ‚ªã„", "å°‘ã—æ‚ªã„", "ãµã¤ã†", "å°‘ã—è‰¯ã„", "è‰¯ã„"];

let weatherData = null;
let chart = null;

// localStorage key
const STORAGE_KEY = "healthData";

// ãƒ‡ãƒ¼ã‚¿å–å¾—
async function fetchWeather() {
  const res = await fetch(API_URL);
  const data = await res.json();
  weatherData = data.hourly;
  buildTable();
  updateChart();
}

// localStorageã‹ã‚‰ä½“èª¿ã‚’å–å¾—
function loadHealthData() {
  return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
}

// localStorageã«ä½“èª¿ã‚’ä¿å­˜
function saveHealthData(data) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

// ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
function buildTable() {
  const table = document.getElementById("dataTable");
  table.innerHTML = "";
  let healthData = loadHealthData();

  let rows = "<tr><th>æ—¥ä»˜</th><th>ä½“èª¿</th></tr>";
  // æ—¥å˜ä½ã§è¡¨ç¤º
  let days = {};
  weatherData.time.forEach((t, i) => {
    let date = t.split("T")[0];
    if (!days[date]) days[date] = i;
  });

  Object.keys(days).forEach(date => {
    let val = healthData[date] || "";
    let options = CONDITION_LEVELS.map(c => 
      `<option value="${c}" ${val===c?"selected":""}>${c}</option>`
    ).join("");
    rows += `<tr><td>${date}</td><td><select data-date="${date}">${options}</select></td></tr>`;
  });

  table.innerHTML = rows;

  // changeã‚¤ãƒ™ãƒ³ãƒˆ
  table.querySelectorAll("select").forEach(sel => {
    sel.addEventListener("change", e => {
      let d = e.target.getAttribute("data-date");
      healthData[d] = e.target.value;
      saveHealthData(healthData);
      updateChart();
    });
  });
}

// ã‚°ãƒ©ãƒ•æ›´æ–°
function updateChart() {
  let period = parseInt(document.getElementById("periodSelect").value);
  let healthData = loadHealthData();

  let times = [];
  let pressures = [];
  let health = [];
  let bgColors = [];

  for (let i=0; i<weatherData.time.length; i+=24) { // 1æ—¥ã”ã¨
    let date = weatherData.time[i].split("T")[0];
    let avgP = weatherData.pressure_msl.slice(i, i+24).reduce((a,b)=>a+b,0)/24;
    times.push(date);
    pressures.push(avgP);
    let cond = healthData[date] || null;
    health.push(cond ? CONDITION_LEVELS.indexOf(cond)+1 : null);

    // å¤©æ°—ã‚³ãƒ¼ãƒ‰ã‹ã‚‰è‰²ã‚’æ±ºå®š
    let wcode = weatherData.weathercode[i];
    let color = "rgba(200,200,200,0.2)";
    if (wcode<3) color="rgba(255,255,0,0.2)"; // æ™´ã‚Œ
    else if (wcode<60) color="rgba(150,150,255,0.2)"; // é›²
    else color="rgba(100,100,255,0.2)"; // é›¨
    bgColors.push(color);
  }

  times = times.slice(-period);
  pressures = pressures.slice(-period);
  health = health.slice(-period);
  bgColors = bgColors.slice(-period);

  if (chart) chart.destroy();
  let ctx = document.getElementById("myChart").getContext("2d");
  chart = new Chart(ctx, {
    type: "line",
    data: {
      labels: times,
      datasets: [
        {
          label: "æ°—åœ§(hPa)",
          data: pressures,
          borderColor: "red",
          yAxisID: "y1",
        },
        {
          label: "ä½“èª¿(1ã€œ5)",
          data: health,
          borderColor: "blue",
          yAxisID: "y2",
        }
      ]
    },
    options: {
      responsive: true,
      scales: {
        y1: {
          type: "linear",
          position: "left",
          title: { display: true, text: "æ°—åœ§(hPa)" }
        },
        y2: {
          type: "linear",
          position: "right",
          min: 1, max: 5, ticks: {
            callback: v => CONDITION_LEVELS[v-1] || ""
          },
          title: { display: true, text: "ä½“èª¿" }
        }
      },
      plugins: {
        legend: { position: "top" },
        tooltip: { mode: "index" },
      }
    },
    plugins: [{
      id: "bg",
      beforeDraw: c => {
        let chartArea = c.chartArea;
        let ctx = c.ctx;
        times.forEach((t, i) => {
          let x = c.scales.x.getPixelForTick(i);
          let nextX = (i<times.length-1)?c.scales.x.getPixelForTick(i+1):chartArea.right;
          ctx.fillStyle = bgColors[i];
          ctx.fillRect(x, chartArea.top, nextX-x, chartArea.bottom-chartArea.top);
        });
      }
    }]
  });
}

// ã‚¤ãƒ™ãƒ³ãƒˆ
document.getElementById("periodSelect").addEventListener("change", updateChart);
document.getElementById("toggleBtn").addEventListener("click", () => {
  const t = document.getElementById("tableContainer");
  if (t.style.display==="none") { t.style.display="block"; document.getElementById("toggleBtn").innerText="å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã‚’éš ã™"; }
  else { t.style.display="none"; document.getElementById("toggleBtn").innerText="å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º"; }
});

// åˆæœŸåŒ–
fetchWeather();
</script>
</body>
</html>
