<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>æ°—åœ§ãƒ»ä½“èª¿å…¥åŠ›ã¨ã‚°ãƒ©ãƒ•ï¼ˆæ±äº¬ãƒ»éå»14æ—¥é–“ï¼‰</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: sans-serif; margin: 20px; background: #f8f9fa; }
  h1 { font-size: 1.4em; margin-bottom: 12px; }
  #toggleBtn { margin-bottom: 16px; padding: 8px 12px; cursor: pointer; }
  #chartContainer, #tableContainer {
    background: white;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
    padding: 20px;
    max-width: 1000px;
    margin-bottom: 24px;
  }
  #tableContainer { display: none; max-height: 500px; overflow-y: auto; }
  table {
    width: 100%; border-collapse: collapse; 
  }
  th, td {
    border: 1px solid #ddd; padding: 8px; text-align: center;
    vertical-align: middle;
  }
  th { background: #f3f3f3; }
  tr.today { background: #fff7cc; font-weight: 700; }
  .up { color: #1b6e20; }
  .down { color: #c02828; }
  .nochange { color: #666; }
  input[type=number] {
    width: 40px;
    font-size: 1em;
    text-align: center;
  }
</style>
</head>
<body>
<h1>éå»14æ—¥é–“ã®æ±äº¬ã®æ°—åœ§ãƒ»ä½“èª¿ã‚¹ã‚³ã‚¢å…¥åŠ›ï¼ˆå¤©å€™èƒŒæ™¯ä»˜ãï¼‰</h1>
<button id="toggleBtn">è¡¨ã«åˆ‡ã‚Šæ›¿ãˆ</button>
<div id="chartContainer">
  <canvas id="pressureChart"></canvas>
</div>
<div id="tableContainer">
  <table>
    <thead>
      <tr>
        <th>æ—¥ä»˜</th><th>å¹³å‡æ°—åœ§ (hPa)</th><th>å‰æ—¥æ¯”</th><th>å¤©å€™</th><th>ä½“èª¿ã‚¹ã‚³ã‚¢ (1ã€œ5)<br><small>å…¥åŠ›å¯èƒ½</small></th>
      </tr>
    </thead>
    <tbody id="dataBody"></tbody>
  </table>
</div>

<script>
(async function() {
  const lat = 35.6895;
  const lon = 139.6917;
  const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=pressure_msl,weathercode&timezone=Asia/Tokyo&past_days=14`;

  const res = await fetch(url);
  const data = await res.json();

  const times = data.hourly.time;
  const pressures = data.hourly.pressure_msl;
  const weatherCodes = data.hourly.weathercode;

  const today = new Date().toISOString().split('T')[0];
  const todayDate = new Date(today);

  // æ—¥åˆ¥ãƒ‡ãƒ¼ã‚¿é›†è¨ˆ
  const daily = {};
  for(let i=0; i<times.length; i++){
    const dateStr = times[i].split('T')[0];
    const dateObj = new Date(dateStr);
    if(dateObj > todayDate) continue;
    if(!daily[dateStr]) daily[dateStr] = { pressure: [], weather: [] };
    daily[dateStr].pressure.push(pressures[i]);
    daily[dateStr].weather.push(weatherCodes[i]);
  }

  const dates = Object.keys(daily).sort();

  function mode(arr) {
    const freq = {};
    arr.forEach(v => { freq[v] = (freq[v] || 0) + 1; });
    return Object.entries(freq).sort((a,b)=>b[1]-a[1])[0][0];
  }

  const dailyData = dates.map(d => {
    const pAvg = daily[d].pressure.reduce((a,b)=>a+b,0)/daily[d].pressure.length;
    const wMode = mode(daily[d].weather);
    return {
      date: d,
      pressure: +pAvg.toFixed(1),
      weatherCode: wMode
    };
  });

  // localStorageã‹ã‚‰ä½“èª¿ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã€ç„¡ã‘ã‚Œã°ç©ºã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
  const storageKey = 'userSymptomData';
  let symptomData = {};
  try {
    const stored = localStorage.getItem(storageKey);
    if(stored) symptomData = JSON.parse(stored);
  } catch(e) { console.warn('localStorage read error', e); }

  function saveSymptomData(){
    localStorage.setItem(storageKey, JSON.stringify(symptomData));
  }

  function weatherToTextIcon(code) {
    const map = {
      0:  ['æ™´ã‚Œ', 'â˜€ï¸', '#FFEE93'],
      1:  ['ä¸»ã«æ™´ã‚Œ', 'ğŸŒ¤ï¸', '#FFE6A7'],
      2:  ['ä¸€éƒ¨æ›‡ã‚Š', 'â›…', '#D0D0D0'],
      3:  ['æ›‡ã‚Š', 'â˜ï¸', '#A0A0A0'],
      45: ['éœ§', 'ğŸŒ«ï¸', '#C8C8C8'],
      48: ['éœ§ï¼ˆæ°·æ™¶ï¼‰', 'ğŸŒ«ï¸', '#C8C8C8'],
      51: ['éœ§é›¨ï¼ˆå¼±ï¼‰', 'ğŸŒ¦ï¸', '#9BC4E2'],
      53: ['éœ§é›¨ï¼ˆä¸­ï¼‰', 'ğŸŒ§ï¸', '#739ED1'],
      55: ['éœ§é›¨ï¼ˆå¼·ï¼‰', 'ğŸŒ§ï¸', '#4D78C1'],
      56: ['å‡çµéœ§é›¨ï¼ˆå¼±ï¼‰', 'ğŸŒ§ï¸â„ï¸', '#7BA1C7'],
      57: ['å‡çµéœ§é›¨ï¼ˆå¼·ï¼‰', 'ğŸŒ§ï¸â„ï¸', '#5675AA'],
      61: ['å°é›¨ï¼ˆå¼±ï¼‰', 'ğŸŒ§ï¸', '#79A7D3'],
      63: ['å°é›¨ï¼ˆä¸­ï¼‰', 'ğŸŒ§ï¸', '#5787B4'],
      65: ['å°é›¨ï¼ˆå¼·ï¼‰', 'ğŸŒ§ï¸', '#3C5D8E'],
      66: ['å‡çµå°é›¨ï¼ˆå¼±ï¼‰', 'ğŸŒ§ï¸â„ï¸', '#6A89B8'],
      67: ['å‡çµå°é›¨ï¼ˆå¼·ï¼‰', 'ğŸŒ§ï¸â„ï¸', '#476597'],
      71: ['å°é›ªï¼ˆå¼±ï¼‰', 'ğŸŒ¨ï¸', '#B4C6D9'],
      73: ['å°é›ªï¼ˆä¸­ï¼‰', 'ğŸŒ¨ï¸', '#94AED5'],
      75: ['å°é›ªï¼ˆå¼·ï¼‰', 'ğŸŒ¨ï¸', '#7597D1'],
      77: ['éœ°ï¼ˆã‚ã‚‰ã‚Œï¼‰', 'ğŸŒ¨ï¸', '#7597D1'],
      80: ['ã«ã‚ã‹é›¨ï¼ˆå¼±ï¼‰', 'ğŸŒ§ï¸â›ˆï¸', '#5376B3'],
      81: ['ã«ã‚ã‹é›¨ï¼ˆä¸­ï¼‰', 'ğŸŒ§ï¸â›ˆï¸', '#4B6CA4'],
      82: ['ã«ã‚ã‹é›¨ï¼ˆå¼·ï¼‰', 'ğŸŒ§ï¸â›ˆï¸', '#41608E'],
      85: ['ã«ã‚ã‹é›ªï¼ˆå¼±ï¼‰', 'ğŸŒ¨ï¸â„ï¸', '#8298CF'],
      86: ['ã«ã‚ã‹é›ªï¼ˆå¼·ï¼‰', 'ğŸŒ¨ï¸â„ï¸', '#6B85B9'],
      95: ['é›·é›¨', 'â›ˆï¸', '#365F94'],
      96: ['é›·é›¨ï¼ˆå°ç²’ã®é›¹ã‚’ä¼´ã†ï¼‰', 'â›ˆï¸â„ï¸', '#2E4E77'],
      99: ['é›·é›¨ï¼ˆå¤§ç²’ã®é›¹ã‚’ä¼´ã†ï¼‰', 'â›ˆï¸â„ï¸', '#24425B']
    };
    return map[code] || ['ä¸æ˜', 'â“', '#FFFFFF'];
  }

  // è¡¨ã®ç”Ÿæˆ
  const tbody = document.getElementById('dataBody');
  function renderTable(){
    tbody.innerHTML = '';
    dailyData.forEach((item,i) => {
      const tr = document.createElement('tr');
      if(item.date === today) tr.classList.add('today');

      const change = i === 0 ? null : +(dailyData[i].pressure - dailyData[i-1].pressure).toFixed(1);
      const changeTd = document.createElement('td');
      if(i === 0){
        changeTd.textContent = 'â€”';
        changeTd.classList.add('nochange');
      } else if(change > 0){
        changeTd.innerHTML = `â–² ${change} hPa`;
        changeTd.classList.add('up');
      } else if(change < 0){
        changeTd.innerHTML = `â–¼ ${Math.abs(change)} hPa`;
        changeTd.classList.add('down');
      } else {
        changeTd.textContent = 'Â±0.0';
        changeTd.classList.add('nochange');
      }

      const [weatherText, weatherIcon, bgColor] = weatherToTextIcon(item.weatherCode);

      tr.innerHTML = `<td>${item.date}</td>
                      <td>${item.pressure}</td>`;
      tr.appendChild(changeTd);
      tr.innerHTML += `<td title="${weatherText}">${weatherIcon}</td>`;

      const symptomTd = document.createElement('td');
      // ä½“èª¿å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ 
      const input = document.createElement('input');
      input.type = 'number';
      input.min = 1;
      input.max = 5;
      input.value = symptomData[item.date] ?? '';
      input.title = '1ã€œ5ã®æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
      input.addEventListener('change', e => {
        const val = Number(e.target.value);
        if(val >=1 && val <=5){
          symptomData[item.date] = val;
          saveSymptomData();
          updateChartData();
        } else {
          alert('1ã€œ5ã®æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          e.target.value = symptomData[item.date] ?? '';
        }
      });
      symptomTd.appendChild(input);
      tr.appendChild(symptomTd);

      tbody.appendChild(tr);
    });
  }

  // ã‚°ãƒ©ãƒ•æ›´æ–°é–¢æ•°
  let chart;
  function updateChartData(){
    const symptomVals = dates.map(d => symptomData[d] ?? null);
    chart.data.datasets[1].data = symptomVals;
    chart.update();
  }

  // èƒŒæ™¯è‰²ã‚’å¤©å€™ã”ã¨ã«ä»˜ã‘ã‚‹ãƒ—ãƒ©ã‚°ã‚¤ãƒ³
  const weatherBgPlugin = {
    id: 'weatherBg',
    beforeDraw(chart) {
      const { ctx, chartArea: { left, right, top, bottom }, scales: { x } } = chart;
      for(let i = 0; i < dailyData.length; i++) {
        const wCode = dailyData[i].weatherCode;
        const [, , bgColor] = weatherToTextIcon(wCode);

        const xStart = i === 0 ? left : x.getPixelForValue(dailyData[i].date);
        let xEnd;
        if(i < dailyData.length - 1) {
          xEnd = x.getPixelForValue(dailyData[i+1].date);
        } else {
          xEnd = right;
        }

        ctx.save();
        ctx.fillStyle = bgColor;
        ctx.globalAlpha = 0.15;
        ctx.fillRect(xStart, top, xEnd - xStart, bottom - top);
        ctx.restore();
      }
    }
  };

  // ã‚°ãƒ©ãƒ•æç”»
  const ctx = document.getElementById('pressureChart').getContext('2d');
  chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: dates,
      datasets: [
        {
          label: 'æ°—åœ§ (hPa)',
          data: dailyData.map(d => d.pressure),
          yAxisID: 'yRight',
          borderColor: 'rgba(54, 162, 235, 1)',
          backgroundColor: 'rgba(54, 162, 235, 0.15)',
          fill: true,
          tension: 0.3,
          pointRadius: 4,
          order: 2
        },
        {
          label: 'ä½“èª¿ã‚¹ã‚³ã‚¢ (1ã€œ5)',
          data: dates.map(d => symptomData[d] ?? null),
          yAxisID: 'yLeft',
          borderColor: 'rgba(255, 99, 132, 1)',
          backgroundColor: 'rgba(255, 99, 132, 0.15)',
          fill: true,
          tension: 0.3,
          pointRadius: 4,
          order: 1
        }
      ]
    },
    options: {
      responsive: true,
      interaction: { mode: 'index', intersect: false },
      stacked: false,
      scales: {
        yLeft: {
          type: 'linear',
          position: 'left',
          min: 0,
          max: 5,
          ticks: { stepSize: 1 },
          title: { display: true, text: 'ä½“èª¿ã‚¹ã‚³ã‚¢' }
        },
        yRight: {
          type: 'linear',
          position: 'right',
          min: Math.min(...dailyData.map(d => d.pressure)) - 5,
          max: Math.max(...dailyData.map(d => d.pressure)) + 5,
          grid: { drawOnChartArea: false },
          title: { display: true, text: 'æ°—åœ§ (hPa)' }
        },
        x: {
          title: { display: true, text: 'æ—¥ä»˜' }
        }
      },
      plugins: {
        legend: { position: 'top' },
        tooltip: {
          enabled: true,
          mode: 'nearest',
          intersect: false,
          callbacks: {
            label: ctx => ctx.dataset.label + ': ' + ctx.formattedValue
          }
        }
      }
    },
    plugins: [weatherBgPlugin]
  });

  renderTable();

  // è¡¨ãƒ»ã‚°ãƒ©ãƒ•åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³
  const toggleBtn = document.getElementById('toggleBtn');
  const chartDiv = document.getElementById('chartContainer');
  const tableDiv = document.getElementById('tableContainer');
  toggleBtn.addEventListener('click', () => {
    if(chartDiv.style.display === 'none'){
      chartDiv.style.display = 'block';
      tableDiv.style.display = 'none';
      toggleBtn.textContent = 'è¡¨ã«åˆ‡ã‚Šæ›¿ãˆ';
    } else {
      chartDiv.style.display = 'none';
      tableDiv.style.display = 'block';
      toggleBtn.textContent = 'ã‚°ãƒ©ãƒ•ã«åˆ‡ã‚Šæ›¿ãˆ';
    }
  });

})();
</script>
</body>
</html>
