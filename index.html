<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ä½“èª¿è¨˜éŒ²ã‚¢ãƒ—ãƒª</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body {
    font-family: sans-serif;
    margin:0; padding:0;
    display:flex; justify-content:center; align-items:flex-start;
    flex-direction:column;
    min-height:100vh; background:#f9f9f9;
  }
  #content { max-width:1000px; width:95%; margin:1em auto; }
  h1 { text-align:center; margin-bottom:16px; }
  #chartContainer, #tableContainer {
    background:white; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1);
    padding:20px; margin-bottom:24px;
  }
  table { width:100%; border-collapse:collapse; }
  th, td { border:1px solid #ccc; padding:6px; text-align:center; vertical-align:middle; }
  th { background:#eee; }
  select.score { padding:4px 6px; border-radius:6px; border:1px solid #ccc; background:#fff; }
  input.memo { width:95%; }
  label { display:block; margin-bottom:1em; }
  #periodSelect { padding:4px 6px; margin-right:16px; }
  button { padding:6px 12px; cursor:pointer; }
</style>
</head>
<body>
<div id="content">
  <h1>ä½“èª¿è¨˜éŒ²ã‚¢ãƒ—ãƒª</h1>

  <label>
    è¡¨ç¤ºæœŸé–“:
    <select id="periodSelect">
      <option value="7">1é€±é–“</option>
      <option value="14" selected>2é€±é–“</option>
      <option value="21">3é€±é–“</option>
      <option value="30">1ãƒ¶æœˆ</option>
      <option value="60">2ãƒ¶æœˆ</option>
      <option value="90">3ãƒ¶æœˆ</option>
    </select>
  </label>
  <button id="toggleBtn">è¡¨ã«åˆ‡ã‚Šæ›¿ãˆ</button>

  <div id="chartContainer">
    <canvas id="pressureChart"></canvas>
  </div>

  <div id="tableContainer" style="display:none;">
    <table>
      <thead>
        <tr>
          <th>æ—¥ä»˜</th><th>å¹³å‡æ°—åœ§ (hPa)</th><th>å‰æ—¥æ¯”</th><th>å¤©å€™</th><th>ä½“èª¿</th><th>ãƒ¡ãƒ¢</th>
        </tr>
      </thead>
      <tbody id="dataBody"></tbody>
    </table>
  </div>
</div>

<script>
(async function(){
const SCORE_LABELS = ["æ‚ªã„","å°‘ã—æ‚ªã„","ãµã¤ã†","å°‘ã—è‰¯ã„","è‰¯ã„"];
const labelToScore = (label)=>{ const idx=SCORE_LABELS.indexOf(label); return idx>=0?idx+1:NaN; };

const lat=35.6895, lon=139.6917;
const storageKey='userSymptomData';
let symptomData={};

// localStorage ã‹ã‚‰èª­ã¿è¾¼ã¿ï¼ˆå¾“æ¥å½¢å¼ã‚‚å¤‰æ›ï¼‰
try{
  let stored=localStorage.getItem(storageKey);
  if(stored){
    let parsed=JSON.parse(stored);
    for(let d in parsed){
      if(typeof parsed[d]==='string') parsed[d]={condition:parsed[d], memo:''};
    }
    symptomData=parsed;
  }
}catch(e){console.warn(e);}
const saveSymptomData=()=>localStorage.setItem(storageKey, JSON.stringify(symptomData));

const fetchWeatherData=async(days)=>{
  const url=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=pressure_msl,weathercode&timezone=Asia/Tokyo&past_days=${days}`;
  const res=await fetch(url);
  return await res.json();
};

function mode(arr){ const freq={}; arr.forEach(v=>{freq[v]=(freq[v]||0)+1;}); return Number(Object.entries(freq).sort((a,b)=>b[1]-a[1])[0][0]); }

function weatherToTextIcon(code){
  const map={
    0:['æ™´ã‚Œ','â˜€ï¸','#FFEE93'],1:['ä¸»ã«æ™´ã‚Œ','ğŸŒ¤ï¸','#FFE6A7'],2:['ä¸€éƒ¨æ›‡ã‚Š','â›…','#D0D0D0'],
    3:['æ›‡ã‚Š','â˜ï¸','#A0A0A0'],45:['éœ§','ğŸŒ«ï¸','#C8C8C8'],48:['éœ§ï¼ˆæ°·æ™¶ï¼‰','ğŸŒ«ï¸','#C8C8C8'],
    51:['éœ§é›¨ï¼ˆå¼±ï¼‰','ğŸŒ¦ï¸','#9BC4E2'],53:['éœ§é›¨ï¼ˆä¸­ï¼‰','ğŸŒ§ï¸','#739ED1'],55:['éœ§é›¨ï¼ˆå¼·ï¼‰','ğŸŒ§ï¸','#4D78C1'],
    61:['å°é›¨ï¼ˆå¼±ï¼‰','ğŸŒ§ï¸','#79A7D3'],63:['å°é›¨ï¼ˆä¸­ï¼‰','ğŸŒ§ï¸','#5787B4'],65:['å°é›¨ï¼ˆå¼·ï¼‰','ğŸŒ§ï¸','#3C5D8E'],
    71:['å°é›ªï¼ˆå¼±ï¼‰','ğŸŒ¨ï¸','#B4C6D9'],73:['å°é›ªï¼ˆä¸­ï¼‰','ğŸŒ¨ï¸','#94AED5'],75:['å°é›ªï¼ˆå¼·ï¼‰','ğŸŒ¨ï¸','#7597D1'],
    95:['é›·é›¨','â›ˆï¸','#365F94'],99:['é›·é›¨ï¼ˆå¤§ç²’ã®é›¹ï¼‰','â›ˆï¸â„ï¸','#24425B']
  };
  return map[code]||['ä¸æ˜','â“','#FFFFFF'];
}

let chart, dailyData=[], dates=[];

const ctx=document.getElementById('pressureChart').getContext('2d');
const weatherBgPlugin={
  id:'weatherBg',
  beforeDraw(chart){
    const {ctx,chartArea:{top,bottom},scales:{x}}=chart;
    dailyData.forEach((d,i)=>{
      const [, , bgColor]=weatherToTextIcon(d.weatherCode);
      const xStart=x.getPixelForValue(d.date);
      const xEnd=(i<dailyData.length-1)?x.getPixelForValue(dailyData[i+1].date):x.getPixelForValue(d.date)+x.getPixelForTick(1)-x.getPixelForTick(0);
      ctx.save();
      ctx.fillStyle=bgColor;
      ctx.globalAlpha=0.3;
      ctx.fillRect(xStart,top,xEnd-xStart,bottom-top);
      ctx.restore();
    });
  }
};

function processData(raw){
  const times = raw?.hourly?.time??[];
  const pressures = raw?.hourly?.pressure_msl??[];
  const weatherCodes = raw?.hourly?.weathercode??[];
  const today=new Date();
  const daily={};
  for(let i=0;i<times.length;i++){
    const dStr=times[i].split('T')[0];
    const dObj=new Date(dStr);
    if(dObj>today) continue;
    if(!daily[dStr]) daily[dStr]={pressure:[],weather:[]};
    daily[dStr].pressure.push(pressures[i]);
    daily[dStr].weather.push(weatherCodes[i]);
  }
  return daily;
}

function mergeData(apiDaily){
  const allDates = new Set([...Object.keys(apiDaily), ...Object.keys(symptomData)]);
  const sortedDates = Array.from(allDates).sort((a,b)=>new Date(b)-new Date(a));
  const merged = sortedDates.map(d=>{
    const api = apiDaily[d];
    const p = api ? api.pressure.reduce((a,b)=>a+b,0)/api.pressure.length : null;
    const w = api ? mode(api.weather) : 0;
    const cond = symptomData[d]?.condition||'';
    const memo = symptomData[d]?.memo||'';
    return {date:d, pressure:p, weatherCode:w, condition:cond, memo: memo};
  });
  // å‰æ—¥æ¯”
  for(let i=0;i<merged.length;i++){
    if(i<merged.length-1) merged[i].prevPressure = merged[i+1].pressure;
    else merged[i].prevPressure = null;
  }
  return merged;
}

function renderTable(){
  const tbody=document.getElementById('dataBody');
  tbody.innerHTML='';
  dailyData.forEach(item=>{
    const tr=document.createElement('tr');
    const changeTd=document.createElement('td');
    const prev=item.prevPressure;
    if(prev===null) changeTd.textContent='â€”';
    else{ const diff=(item.pressure-prev).toFixed(1); changeTd.textContent=diff>0?`â–² ${diff}`:(diff<0?`â–¼ ${Math.abs(diff)}`:'Â±0'); }
    const [wText,wIcon]=weatherToTextIcon(item.weatherCode);
    const sel=document.createElement('select'); sel.className='score';
    const placeholder=document.createElement('option'); placeholder.value=''; placeholder.textContent='ä½“èª¿ã‚’å…¥åŠ›'; sel.appendChild(placeholder);
    SCORE_LABELS.forEach(lbl=>{ const opt=document.createElement('option'); opt.value=lbl; opt.textContent=lbl; sel.appendChild(opt); });
    sel.value=item.condition;
    sel.addEventListener('change',e=>{
      if(!symptomData[item.date]) symptomData[item.date]={condition:'',memo:''};
      symptomData[item.date].condition=e.target.value;
      saveSymptomData(); updateChartData();
    });
    const memoInput=document.createElement('input'); memoInput.type='text'; memoInput.maxLength=100; memoInput.className='memo';
    memoInput.value=item.memo;
    memoInput.addEventListener('input',e=>{
      if(!symptomData[item.date]) symptomData[item.date]={condition:'',memo:''};
      symptomData[item.date].memo=e.target.value;
      saveSymptomData();
    });
    tr.innerHTML=`<td>${item.date}</td><td>${item.pressure??'â€”'}</td>`; tr.appendChild(changeTd);
    tr.innerHTML+=`<td title="${wText}">${wIcon}</td>`; tr.appendChild(sel); tr.appendChild(memoInput);
    tbody.appendChild(tr);
  });
}

function updateChartData(){
  dates=dailyData.map(d=>d.date);
  chart.data.labels=dates;
  chart.data.datasets[0].data=dailyData.map(d=>d.pressure);
  chart.data.datasets[1].data=dailyData.map(d=>labelToScore(d.condition));
  chart.update();
}

async function render(days){
  const raw=await fetchWeatherData(days);
  const apiDaily = processData(raw);
  dailyData = mergeData(apiDaily);

  if(chart) chart.destroy();
  chart=new Chart(ctx,{
    type:'line',
    data:{
      labels:dates,
      datasets:[
        {label:'å¹³å‡æ°—åœ§(hPa)', data:dailyData.map(d=>d.pressure), borderColor:'red', yAxisID:'y1'},
        {label:'ä½“èª¿(1-5)', data:dailyData.map(d=>labelToScore(d.condition)), borderColor:'blue', yAxisID:'y2'}
      ]
    },
    options:{
      responsive:true,
      scales:{
        y1:{type:'linear',position:'left',title:{display:true,text:'æ°—åœ§(hPa)'}},
        y2:{type:'linear',position:'right',min:1,max:5,ticks:{callback:v=>SCORE_LABELS[v-1]||''},title:{display:true,text:'ä½“èª¿'}}
      }
    },
    plugins:[weatherBgPlugin]
  });

  renderTable();
  updateChartData();
}

// è¡¨åˆ‡æ›¿
document.getElementById('toggleBtn').addEventListener('click',()=>{
  const t=document.getElementById('tableContainer');
  if(t.style.display==='none'){t.style.display='block';document.getElementById('toggleBtn').innerText='è¡¨ã‚’éš ã™';}
  else{t.style.display='none';document.getElementById('toggleBtn').innerText='è¡¨ã«åˆ‡ã‚Šæ›¿ãˆ';}
});

// æœŸé–“åˆ‡æ›¿
document.getElementById('periodSelect').addEventListener('change',e=>render(+e.target.value));

render(14);
})();
</script>
</body>
</html>
