<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>体調記録アプリ</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: sans-serif;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      max-width: 900px;
      width: 100%;
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }
    th {
      background: #f0f0f0;
    }
    select, textarea {
      width: 95%;
    }
  </style>
</head>
<body>
<div class="container">
  <h1>体調記録アプリ</h1>

  <label for="period">表示期間：</label>
  <select id="period">
    <option value="7">1週間</option>
    <option value="14">2週間</option>
    <option value="21">3週間</option>
    <option value="30">1ヶ月</option>
    <option value="90">3ヶ月</option>
  </select>

  <canvas id="chart" height="120"></canvas>

  <table id="dataTable">
    <thead>
      <tr>
        <th>日付</th>
        <th>体調</th>
        <th>メモ</th>
        <th>気圧の前日比(hPa)</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
const ctx = document.getElementById('chart').getContext('2d');
let chart;

const conditionLevels = ["", "良い", "少し良い", "ふつう", "少し悪い", "悪い"];

function saveData(date, condition, memo) {
  let data = JSON.parse(localStorage.getItem("healthData")) || {};
  if (!data[date]) data[date] = {};
  data[date].condition = condition;
  data[date].memo = memo;
  localStorage.setItem("healthData", JSON.stringify(data));
}

function loadData() {
  return JSON.parse(localStorage.getItem("healthData")) || {};
}

// 気圧APIデータ取得
async function fetchPressureData(startDate, endDate) {
  // ダミーデータ（本番はAPI呼び出し）
  const data = {};
  let current = new Date(startDate);
  while (current <= endDate) {
    data[current.toISOString().split("T")[0]] = {
      pressure: 1000 + Math.sin(current.getTime()/8.64e7)*10,
      weather: "sunny"
    };
    current.setDate(current.getDate()+1);
  }
  return data;
}

function renderTableAndChart(periodDays) {
  const tbody = document.querySelector("#dataTable tbody");
  tbody.innerHTML = "";

  const today = new Date();
  const startDate = new Date();
  startDate.setDate(today.getDate() - periodDays + 1);

  const storedData = loadData();

  fetchPressureData(startDate, today).then(apiData => {
    const allDates = new Set([
      ...Object.keys(storedData),
      ...Object.keys(apiData)
    ]);

    const sortedDates = Array.from(allDates).sort((a,b)=> new Date(b)-new Date(a));

    const labels = [];
    const pressures = [];
    const conditions = [];

    let prevPressure = null;

    sortedDates.forEach(date => {
      const local = storedData[date] || {};
      const api = apiData[date] || {};

      if (new Date(date) < startDate) return;

      labels.unshift(date); // グラフは古い→新しい順で右にいくようにunshift

      pressures.unshift(api.pressure ?? null);
      conditions.unshift(local.condition ? conditionLevels.indexOf(local.condition) : null);

      let tr = document.createElement("tr");

      // 日付
      let tdDate = document.createElement("td");
      tdDate.textContent = date;
      tr.appendChild(tdDate);

      // 体調プルダウン
      let tdCondition = document.createElement("td");
      let select = document.createElement("select");
      conditionLevels.forEach(level => {
        let opt = document.createElement("option");
        opt.value = level;
        opt.textContent = level;
        if (level === (local.condition || "")) opt.selected = true;
        select.appendChild(opt);
      });
      select.onchange = () => saveData(date, select.value, textarea.value);
      tdCondition.appendChild(select);
      tr.appendChild(tdCondition);

      // メモ
      let tdMemo = document.createElement("td");
      let textarea = document.createElement("textarea");
      textarea.maxLength = 100;
      textarea.value = local.memo || "";
      textarea.oninput = () => saveData(date, select.value, textarea.value);
      tdMemo.appendChild(textarea);
      tr.appendChild(tdMemo);

      // 前日比
      let tdDiff = document.createElement("td");
      if (api.pressure != null && prevPressure != null) {
        tdDiff.textContent = (api.pressure - prevPressure).toFixed(1);
      } else {
        tdDiff.textContent = "-";
      }
      tr.appendChild(tdDiff);

      prevPressure = api.pressure ?? prevPressure;

      tbody.appendChild(tr);
    });

    if (chart) chart.destroy();
    chart = new Chart(ctx, {
      type: "line",
      data: {
        labels: labels,
        datasets: [
          {
            label: "気圧(hPa)",
            data: pressures,
            borderColor: "blue",
            yAxisID: "y",
            spanGaps: true
          },
          {
            label: "体調(5段階)",
            data: conditions,
            borderColor: "red",
            yAxisID: "y1",
            spanGaps: true
          }
        ]
      },
      options: {
        responsive: true,
        interaction: { mode: "index", intersect: false },
        scales: {
          y: { type: "linear", position: "left" },
          y1: { type: "linear", position: "right", min:0, max:5, ticks:{stepSize:1} }
        }
      }
    });
  });
}

document.getElementById("period").addEventListener("change", e=>{
  renderTableAndChart(parseInt(e.target.value));
});

renderTableAndChart(7);
</script>
</body>
</html>
