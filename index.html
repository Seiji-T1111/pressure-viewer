<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>血圧ビューアー</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background: #f9f9f9;
    }
    .container {
      max-width: 900px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
    }
    #controls {
      text-align: center;
      margin-bottom: 20px;
    }
    select {
      padding: 6px 10px;
      font-size: 16px;
    }
    canvas {
      width: 100% !important;
      height: 400px !important;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>血圧ビューアー</h1>

    <!-- プルダウン -->
    <div id="controls">
      <label for="rangeSelect">表示期間：</label>
      <select id="rangeSelect">
        <option value="7">直近7日</option>
        <option value="14" selected>直近14日</option>
        <option value="30">直近30日</option>
        <option value="90">直近3ヶ月</option>
      </select>
    </div>

    <!-- グラフ -->
    <canvas id="bpChart"></canvas>
  </div>

  <script>
    // ★ Google Apps Script Web API のURLをここに設定してください
    const API_URL = "https://script.google.com/macros/s/XXXX/exec";

    let chart;
    let allData = [];

    // データ取得
    async function fetchData() {
      const res = await fetch(API_URL);
      const data = await res.json();
      allData = data;
      updateChart(14); // デフォルト14日
    }

    // グラフ更新
    function updateChart(days) {
      if (!allData.length) return;

      const now = new Date();
      const cutoff = new Date();
      cutoff.setDate(now.getDate() - days);

      // データをフィルタリング
      const filtered = allData.filter(item => {
        const d = new Date(item.date);
        return d >= cutoff;
      });

      const labels = filtered.map(item => item.date);
      const sys = filtered.map(item => item.systolic);
      const dia = filtered.map(item => item.diastolic);

      const ctx = document.getElementById("bpChart").getContext("2d");

      if (chart) chart.destroy();

      chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: labels,
          datasets: [
            {
              label: "収縮期血圧 (上)",
              data: sys,
              borderColor: "red",
              fill: false
            },
            {
              label: "拡張期血圧 (下)",
              data: dia,
              borderColor: "blue",
              fill: false
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: "top" },
            title: { display: true, text: `直近${days}日の血圧推移` }
          }
        }
      });
    }

    // プルダウン操作
    document.getElementById("rangeSelect").addEventListener("change", (e) => {
      const days = parseInt(e.target.value, 10);
      updateChart(days);
    });

    fetchData();
  </script>
</body>
</html>
