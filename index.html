<canvas id="pressureChart" width="1200" height="400"></canvas>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
fetch('https://api.open-meteo.com/v1/forecast?latitude=35.6895&longitude=139.6917&hourly=pressure_msl&timezone=Asia%2FTokyo&past_days=30')
  .then(res => res.json())
  .then(data => {
    const times = data.hourly.time;
    const pressures = data.hourly.pressure_msl;

    // 日ごとの平均気圧計算
    const dailyData = {};
    times.forEach((time, i) => {
      const date = time.split('T')[0];
      if (!dailyData[date]) dailyData[date] = [];
      dailyData[date].push(pressures[i]);
    });

    const labels = Object.keys(dailyData);
    const averages = labels.map(date => {
      const arr = dailyData[date];
      return (arr.reduce((a, b) => a + b, 0) / arr.length).toFixed(1);
    });

    // 前日比（矢印）
    const changes = averages.map((val, i) => {
      if (i === 0) return '';
      const diff = val - averages[i - 1];
      if (diff > 0) return '↑';
      if (diff < 0) return '↓';
      return '→';
    });

    const today = new Date().toISOString().split('T')[0];

    // Chart.js
    const ctx = document.getElementById('pressureChart').getContext('2d');
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: '平均気圧 (hPa)',
          data: averages,
          borderColor: 'blue',
          fill: false,
          tension: 0.1
        }]
      },
      options: {
        responsive: false,
        scales: {
          x: {
            ticks: {
              callback: function(val, index) {
                const date = labels[index];
                return date === today ? '★' + date : date;
              }
            },
            grid: {
              color: ctx => {
                const date = labels[ctx.index];
                return date === today ? '#ccc' : '#eee';
              }
            }
          }
        }
      }
    });

    // 表作成
    let tableHTML = '<table border="1" style="border-collapse:collapse;margin-top:10px;">';
    tableHTML += '<tr><th>日付</th><th>平均気圧</th><th>変化</th></tr>';
    labels.forEach((date, i) => {
      tableHTML += `<tr${date === today ? ' style="background-color:lightgray;"' : ''}>` +
                   `<td><b>${date}</b></td>` +
                   `<td>${averages[i]}</td>` +
                   `<td>${changes[i]}</td>` +
                   `</tr>`;
    });
    tableHTML += '</table>';
    document.body.innerHTML += tableHTML;
  });
</script>
